<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>webRL - GRPO Bipedal Walker</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>
<canvas id="sim"></canvas>
<div id="panel">
<div class="sec">
<h3>制御</h3>
<button id="btnTrain">学習開始</button>
<button id="btnTest">テスト</button>
<button id="btnReset">リセット</button>
<button id="btnSpeed">1x</button>
<span id="workerStatus" style="color:#4f4;margin-left:5px">●Ready</span>
</div>

<div class="sec">
<h3>GRPO</h3>
<div class="row"><label>グループ</label><input type="range" id="groupSize" min="8" max="64" value="24"><span>24</span></div>
<div class="row"><label>学習率</label><input type="range" id="lr" min="-4" max="-1" step="0.1" value="-2.5"><span>3e-3</span></div>
<div class="row"><label>エントロピー</label><input type="range" id="entropy" min="0" max="0.1" step="0.005" value="0.02"><span>0.02</span></div>
<div class="row"><label>EP長</label><input type="range" id="epLen" min="100" max="500" step="20" value="200"><span>200</span></div>
</div>

<div class="sec">
<h3>報酬</h3>
<div class="row"><label>前進</label><input type="range" id="rVel" min="0" max="5" step="0.1" value="2.5"><span>2.5</span></div>
<div class="row"><label>姿勢</label><input type="range" id="rUp" min="0" max="3" step="0.1" value="1.5"><span>1.5</span></div>
<div class="row"><label>高さ</label><input type="range" id="rH" min="0" max="2" step="0.1" value="0.8"><span>0.8</span></div>
<div class="row"><label>効率</label><input type="range" id="rEff" min="0" max="0.3" step="0.01" value="0.03"><span>0.03</span></div>
<div class="row"><label>転倒</label><input type="range" id="rFall" min="0" max="15" step="0.5" value="8"><span>8</span></div>
</div>

<div class="sec">
<h3>物理</h3>
<div class="row"><label>トルク</label><input type="range" id="torque" min="0.02" max="0.15" step="0.01" value="0.06"><span>0.06</span></div>
<div class="row"><label>摩擦</label><input type="range" id="friction" min="0.5" max="1.5" step="0.1" value="1.0"><span>1.0</span></div>
</div>

<div class="sec">
<h3>学習曲線</h3>
<canvas id="chart" height="45"></canvas>
</div>

<div class="sec">
<h3>状態(white) / 行動(cyan)</h3>
<div class="grid" id="stateGrid"></div>
</div>

<div class="sec">
<h3>モニター</h3>
<div class="grid">
<div>EP:<b id="mEp">0</b></div>
<div>R:<b id="mR">0</b></div>
<div>D:<b id="mD">0</b></div>
<div>状態:<b id="mS">待機</b></div>
<div>損失:<b id="mL">-</b></div>
<div>FPS:<b id="mF">0</b></div>
</div>
</div>

<div class="sec">
<h3>ログ</h3>
<div id="log"></div>
</div>
</div>

<!-- External libraries -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

<!-- Worker script content will be loaded dynamically -->
<script id="workerScript" type="text/plain"></script>

<!-- Application modules -->
<script src="js/grpo.js"></script>
<script src="js/environment.js"></script>

<!-- Load worker code into the script tag -->
<script>
(async function() {
  try {
    const workerCode = await fetch('js/worker.js').then(r => r.text());
    document.getElementById('workerScript').textContent = workerCode;
    // Dispatch event to signal worker code is ready
    window.dispatchEvent(new Event('workerReady'));
  } catch (error) {
    console.error('Failed to load worker:', error);
  }
  
  // Load main app
  const script = document.createElement('script');
  script.src = 'js/app.js';
  document.body.appendChild(script);
})();
</script>
</body>
</html>
